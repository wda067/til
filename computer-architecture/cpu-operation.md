# CPU의 작동 원리

- CPU는 메모리에 저장된 명령어를 읽어 들이고, 해석하고, 실행하는 장치
- CPU 내부:
  - ALU: 계산을 담당
  - 제어장치: 명령어를 읽어 들이고 해석
  - 레지스터: 작은 임시 저장 장치

## ALU

1. **레지스터를 통해 피연산자를 받아들임.**
2. **제어장치로부터 수행할 연산을 알려주는 제어 신호를 받아들임.**
3. **연산 수행**
4. **수행한 결과는 일시적으로 레지스터에 저장**
    - CPU가 메모리에 접근하는 속도는 레지스터에 접근하는 속도보다 **훨씬 느리다.**
    - 연산할 떄마다 결과를 메모리에 저장한다면, CPU가 프로그램 실행 속도를 늦출 수 있다.
5. **플래그 레지스터에 플래그를 저장**
    - 플래그: 연산 결과에 대한 추가적인 상태 정보
    - 부호 플래그
    - 제로 플래그
    - 캐리 플래그
    - 오버플로우 플래그
    - 인터럽트 플래그
    - 슈퍼바이저 플래스

## 제어장치

1. **제어장치는 클럭 신호를 받아들인다.**
2. **'해석해야 할 명령어'를 받아들인다.**
    - CPU가 해석해야 할 명령어는 명령어 레지스터에 저장된다.
3. **플래그 레지스터 속 플래그 값을 받아들인다.**
4. **제어 버스로 전달된 제어 신호를 받아들인다.**
5. **CPU 외부 또는 내부에 제어 신호를 전달한다.**
    - **CPU 외부**
      - 제어 버스로 제어 신호를 내보낸다.
        - 메모리에 전달   
        - 입출력장치에 전달
    - **CPU 내부**
      - ALU에 전달
      - 레지스터에 전달

## 레지스터

- 프로그램 속 명령어와 데이터는 실행 전후로 반드시 레지스터에 저장된다.
- 상용화된 CPU 속 레지스터들은 CPU마다 이름, 크기, 종류가 매우 다양하다.

### 프로그램 카운터

메모리에서 가져올 명령어의 주소를 저장한다.

### 명령어 레지스터

해석할 명령어, 즉 방금 메모리에서 읽어 들인 명령어를 저장한다.

### 메모리 주소 레지스터

메모리의 주소를 저장하며, CPU가 읽어 들이고자 하는 주소 값을 주소 버스를 보낼 때 거치게 된다.

### 메모리 버퍼 레지스터

메모리와 주고받을 값(데이터와 명령어)을 저장하며, 데이터 버스로 주고 받을 값이 거치게 된다.

### 메모리에 저장된 프로그램을 실행하는 과정

1. **프로그램 카운터**에 실행할 명령어의 주소, `1000`을 저장한다.
2. `1000`의 명령어를 읽어 오기 위해 **메모리 주소 레지스터**에 `1000`을 저장한다.
3. `메모리 읽기` 제어 신호와 메모리 주소 레지스터 값이 각각 제어 버스와 주소 버스를 통해 메모리에 보내진다.
4. 메모리 `1000`에 저장된 값은 데이터 버스를 통해 **메모리 버퍼 레지스터**로 전달되고, **프로그램 카운터**는 증가되어 다음 명령어를 읽어 드릴 준비를 한다.
5. **메모리 버퍼 레지스터**에 저장된 값은 **명령어 레지스터**로 이동한다.
6. `1000`의 명령어 처리가 끝나면 CPU는 다음 명령어를 읽어 들인다.

→ 이 과정이 반복되면서 CPU는 프로그램을 차례대로 실행해 나간다.

### 범용 레지스터

일반적인 상황에서 자유롭게 사용할 수 있는 레지스터

### 플래그 레지스터

연산 결과 또는 CPU 상태에 대한 부가적인 정보(플래그)를 저장하는 레지스터

### 스택 포인터

스택 주소 지정 방식에서 사용되는 레지스터, 스택의 꼭대기를 가리킨다.

### 변위 주소 지정 방식

오퍼랜드 필드의 값과 특정 레지스터의 값을 더하여 유효 주소를 얻어내는 주소 지정 방식

#### 상대 주소 지정 방식

오퍼랜드와 **프로그램 카운터**의 값을 더하여 유효 주소를 얻는 방식

#### 베이스 레지스터 주소 지정 방식

오퍼랜드(기준 주소로부터 떨어진 거리)와 **베이스 레지스터(기준 주소)** 의 값을 더하여 유효 주소를 얻는 방식

## 명령어 사이클

- 프로그램은 수많은 명령어로 이루어져 있고, CPU는 이 명령어들을 하나씩 실행한다.
- 이때 프로그램 속 각각의 명령어들은 일정한 주기가 반복되며 실행되는데, 이 주기를 **명령어 사이클**이라 한다.

### 인출 사이클

메모리에 있는 명령어를 CPU로 가져오는 단계

### 실행 사이클

CPU로 가져온 명령어를 실행하는 단계

### 간접 사이클

명령어를 실행하기 위해 메모리 접근이 더 필요한 경우

## 인터럽트

CPU의 작업을 방해하는 신호

### 동기 인터럽트(예외)

CPU에 의해 발생하는 인터럽트, 예외라고 부른다.

#### 폴트

예외를 처리한 직후 예외가 발생한 명령어부터 실행을 재개하는 예외

#### 트랩

예외를 처리한 직후 예외가 발생한 명령어의 다음 명령어부터 실행을 재개하는 예외, 주로 디버깅할 때 사용한다.

#### 어볼트

CPU가 실행 중인 프로그램을 강제로 중단시킬 수 밖에 없는 심각한 오류

#### 소프트웨어 인터럽트

시스템 호출이 발생했을 때 나타난다.

### 비동기 인터럽트(인터럽트)

주로 입출력장치에 의해 발생하는(완료 알림 등) 인터럽트, 일반적으로 인터럽트라고 부른다.

#### CPU가 인터럽트를 처리하는 순서

1. 입출력장치는 CPU에 **인터럽트 요청 신호**를 보낸다.
    - **인터럽트 요청 신호**: CPU의 작업을 방해하는 인터럽트에 대한 요청
2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부를 확인한다.
3. CPU는 인터럽트 요청을 확인하고 **인터럽트 플래그**를 통해 현재 인터럽트를 받아들일 수 있는지 여부를 확인한다.
    - **인터럽트 플래그**: 인터럽트 요청 신호를 받아들일지 무시할지를 결정하는 비트
4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업한다.
5. CPU는 **인터럽트 벡터**를 참조하여 **인터럽트 서비스 루틴**을 실행한다.
    - **인터럽트 벡터**: 인터럽트 서비스 루틴의 시작 주소를 포함하는 인터럽트 서비스 루틴의 식별 정보
    - **인터럽트 서비스 루틴**: 인터럽트를 처리하는 프로그램
6. 인터럽트 서비스 루틴 실행이 끝나면 백업해 둔 작업을 복구하여 실행을 재개한다.
